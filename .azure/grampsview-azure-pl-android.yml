name: GrampsView Android
  
variables:
  - name: appBase
    value: 'GrampsView'

  - name: appxPackageDir
    value: '$(build.artifactStagingDirectory)\AppxPackages\\'

  - name: buildConfiguration
    value: 'Debug'
 
  - name: outputDirectory
    value: '$(build.binariesDirectory)\$(BuildConfiguration)'

  - name: projects
    value: '$(Build.SourcesDirectory)/GrampsView/*.csproj'

  - name: solution
    value: '**/*.sln'

  
  - group: android-pipeline

# - name: apksignerKeystoreFile
#    value: 'cf835e92-be61-4b97-98f2-c3780006eab8'

resources:
  repositories: 
  - repository: shared 
    name: Shared/Shared
    type: git

trigger:
    tags:
        include:
        - v*

pr: none


jobs:
- job: GrampsViewAndroid
  timeoutInMinutes: 15 # how long to run the job before automatically cancelling
  cancelTimeoutInMinutes: 2 # how much time to give 'run always even if cancelled tasks' before stopping them
  
  pool:
    name: Azure Pipelines
    vmImage: 'windows-latest'
    demands:
    - MSBuild
    - Xamarin.Android
    - JDK

  steps:
  - checkout: self
    submodules: true

  - task: NuGetAuthenticate@1
    inputs:
      nuGetServiceConnections: 'SharedSharpNuFeed'
      forceReinstallCredentialProvider: true
      
  - template: /.azure/android/azure-build-android.yml@shared
    parameters:
      appBase: '$(appBase)'

  - task: AppCenterDistribute@3
    displayName: 'Deploy $(Build.ArtifactStagingDirectory)\**\$(appBase)*.apx to Visual Studio App Center'
    inputs:
      serverEndpoint: 'App Center'
      appSlug: 'phandcock-ilr0/GrampsViewXam'
      appFile: '$(Build.ArtifactStagingDirectory)\**\$(appBase)*.apx'
      symbolsOption: 'Android'
      releaseNotesOption: 'file'
      releaseNotesFile: 'CHANGELOG.md'
      destinationType: 'groups'
      distributionGroupId: 'e9e85188-6f54-4868-9759-992c446d5145'
    condition: succeededOrFailed()

